"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function toRelative(e,t){var r=t.endsWith(SEP)?t:t+SEP,n=e.substr(r.length);return n.startsWith(SEP)&&(n=n.substr(1)),n.replace(/\\/g,"/")}function responseError(e){var t=new Error("Response error");if(t.status=e.status,429===e.status){var r=e.headers.get("Retry-After");r&&(t.retryAfter=parseInt(r,10))}return t}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_getFiles=require("./get-files"),_getFiles2=_interopRequireDefault(_getFiles),_hash=require("./hash"),_hash2=_interopRequireDefault(_hash),_retry=require("./retry"),_retry2=_interopRequireDefault(_retry),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_agent=require("./agent"),_agent2=_interopRequireDefault(_agent),_events=require("events"),_events2=_interopRequireDefault(_events),_path=require("path"),_fsPromise=require("fs-promise"),_resumer=require("resumer"),_resumer2=_interopRequireDefault(_resumer),_splitArray=require("split-array"),_splitArray2=_interopRequireDefault(_splitArray),ONEMB=(0,_bytes2["default"])("1mb"),MAX_CONCURRENT=10,IS_WIN=/^win/.test(process.platform),SEP=IS_WIN?"\\":"/",Now=function(e){function t(e,r,n){var s=n.forceNew,a=void 0===s?!1:s,o=n.debug,u=void 0===o?!1:o;(0,_classCallCheck3["default"])(this,t);var i=(0,_possibleConstructorReturn3["default"])(this,(0,_getPrototypeOf2["default"])(t).call(this));return i._token=r,i._debug=u,i._forceNew=a,i._agent=new _agent2["default"](e,{debug:u}),i._onRetry=i._onRetry.bind(i),i}return(0,_inherits3["default"])(t,e),(0,_createClass3["default"])(t,[{key:"create",value:function(){function e(e,r){return t.apply(this,arguments)}var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,s,a,o,u,i,l,c,_=this,f=t.forceNew,d=t.forceSync;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this._path=e,t.prev=1,t.next=4,(0,_fsPromise.stat)(e);case 4:t.next=11;break;case 6:throw t.prev=6,t.t0=t["catch"](1),n=new Error("Could not read directory "+e+"."),n.userError=!0,n;case 11:return s=void 0,t.prev=12,t.next=15,(0,_fsPromise.readFile)((0,_path.resolve)(e,"package.json"));case 15:s=t.sent,s=JSON.parse(s),t.next=24;break;case 19:throw t.prev=19,t.t1=t["catch"](12),a=Error('Failed to read JSON in "'+e+'/package.json"'),a.userError=!0,a;case 24:if(null!=s.name&&"string"==typeof s.name){t.next=28;break}throw o=Error("Missing or invalid `name` in `package.json`."),o.userError=!0,o;case 28:if(s.scripts&&(s.scripts.start||s.scripts["now-start"])){t.next=32;break}throw u=Error("Missing `start` (or `now-start`) script in `package.json`. See: https://docs.npmjs.com/cli/start."),u.userError=!0,u;case 32:return this._debug&&console.time("> [debug] Getting files"),t.next=35,(0,_getFiles2["default"])(e,s,{limit:ONEMB,debug:this._debug});case 35:return i=t.sent,this._debug&&console.timeEnd("> [debug] Getting files"),this._debug&&console.time("> [debug] Computing hashes"),t.next=40,(0,_hash2["default"])(i);case 40:return l=t.sent,this._debug&&console.timeEnd("> [debug] Computing hashes"),this._files=l,t.next=45,(0,_retry2["default"])(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(t){var n;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return _._debug&&console.time("> [debug] /create"),r.next=3,_._fetch("/create",{method:"POST",body:{forceNew:f,forceSync:d,name:s.name||(0,_path.basename)(e),description:s.description,files:Array.prototype.concat.apply([],(0,_from2["default"])(_._files).map(function(e){var t=(0,_slicedToArray3["default"])(e,2),r=t[0],n=t[1],s=n.data,a=n.names;return a.map(function(e){return{sha:r,size:s.length,file:toRelative(e,_._path)}})}))}});case 3:if(n=r.sent,_._debug&&console.timeEnd("> [debug] /create"),!(200!==n.status&&400<=n.status&&500>n.status)){r.next=8;break}return _._debug&&console.log("> [debug] bailing on creating due to %s",n.status),r.abrupt("return",t(responseError(n)));case 8:if(200===n.status){r.next=10;break}throw new Error("Deployment initialization failed");case 10:return r.abrupt("return",n.json());case 11:case"end":return r.stop()}},r,_)}));return function(e){return t.apply(this,arguments)}}(),{retries:3,minTimeout:2500,onRetry:this._onRetry});case 45:return c=t.sent,this._id=c.deploymentId,this._host=c.url,this._missing=c.missing||[],t.abrupt("return",this._url);case 50:case"end":return t.stop()}},r,this,[[1,6],[12,19]])}));return e}()},{key:"upload",value:function(){var e=this,t=(0,_splitArray2["default"])(this._missing,MAX_CONCURRENT);this._debug&&console.log("> [debug] Will upload "+(this._missing.length+" files in "+t.length+" ")+("steps of "+MAX_CONCURRENT+" uploads."));var r=function n(){_promise2["default"].all(t.shift().map(function(t){return(0,_retry2["default"])(function(){var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(r){var s,a,o,u,i;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return s=e._files.get(t),a=s.data,o=s.names,e._debug&&console.time("> [debug] /sync "+o.join(" ")),u=(0,_resumer2["default"])().queue(a).end(),n.next=7,e._fetch("/sync",{method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":a.length,"x-now-deployment-id":e._id,"x-now-sha":t,"x-now-file":o.map(function(t){return toRelative(t,e._path)}).join(","),"x-now-size":a.length},body:u});case 7:if(i=n.sent,e._debug&&console.timeEnd("> [debug] /sync "+o.join(" ")),200===i.status||!(400<=i.status||500>i.status)){n.next=12;break}return e._debug&&console.log("> [debug] bailing on creating due to %s",i.status),n.abrupt("return",r(responseError(i)));case 12:e.emit("upload",s);case 13:case"end":return n.stop()}},n,e)}));return function(e){return r.apply(this,arguments)}}(),{retries:5,randomize:!0,onRetry:e._onRetry})})).then(function(){return t.length?n():e.emit("complete")})["catch"](function(t){return e.emit("error",t)})};r()}},{key:"list",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var t,n,s,a=this;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t=e?"?app="+encodeURIComponent(e):"",r.next=3,(0,_retry2["default"])(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var n;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a._debug&&console.time("> [debug] /list"),r.next=3,a._fetch("/list"+t);case 3:if(n=r.sent,a._debug&&console.timeEnd("> [debug] /list"),!(400<=n.status&&500>n.status)){r.next=8;break}return a._debug&&console.log("> [debug] bailing on listing due to %s",n.status),r.abrupt("return",e(responseError(n)));case 8:if(200===n.status){r.next=10;break}throw new Error("Fetching deployment list failed");case 10:return r.abrupt("return",n.json());case 11:case"end":return r.stop()}},r,a)}));return function(t){return e.apply(this,arguments)}}(),{retries:3,minTimeout:2500,onRetry:this._onRetry});case 3:return n=r.sent,s=n.deployments,r.abrupt("return",s);case 6:case"end":return r.stop()}},r,this)}));return e}()},{key:"remove",value:function(){function e(e,r){return t.apply(this,arguments)}var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,s=this,a=t.hard;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={deploymentId:e,hard:a},t.next=3,(0,_retry2["default"])(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s._debug&&console.time("> [debug] /remove"),t.next=3,s._fetch("/remove",{method:"DELETE",body:n});case 3:if(r=t.sent,s._debug&&console.timeEnd("> [debug] /remove"),!(400<=r.status&&500>r.status)){t.next=8;break}return s._debug&&console.log("> [debug] bailing on removal due to %s",r.status),t.abrupt("return",e(responseError(r)));case 8:if(200===r.status){t.next=10;break}throw new Error("Removing deployment failed");case 10:case"end":return t.stop()}},t,s)}));return function(t){return e.apply(this,arguments)}}(),{retries:3,minTimeout:2500,onRetry:this._onRetry});case 3:return t.abrupt("return",!0);case 4:case"end":return t.stop()}},r,this)}));return e}()},{key:"_onRetry",value:function(e){this._debug&&console.log("> [debug] Retrying: "+e.stack)}},{key:"close",value:function(){this._agent.close()}},{key:"_fetch",value:function(){function e(e,r){return t.apply(this,arguments)}var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t.headers=t.headers||{},t.headers.authorization="Bearer "+this._token,r.next=4,this._agent.fetch(e,t);case 4:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}},r,this)}));return e}()},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return"https://"+this._host}},{key:"host",get:function(){return this._host}},{key:"syncAmount",get:function(){var e=this;return this._syncAmount||(this._syncAmount=this._missing.map(function(t){return e._files.get(t).data.length}).reduce(function(e,t){return e+t},0)),this._syncAmount}}]),t}(_events2["default"]);exports["default"]=Now;