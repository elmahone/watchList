#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function printLogs(e){var r=new _buildLogger2["default"](e);r.on("error",function(){console.log("> Connection error."),process.exit(1)}),r.on("close",function(){console.log(""+_chalk2["default"].cyan("> Deployment complete!")),process.exit(0)})}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var o,n,t,a,i,c;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=Date.now(),console.log('> Deploying "'+path+'"'),n=new _lib2["default"](apiUrl,e,{debug:debug}),r.prev=3,r.next=6,n.create(path,{forceNew:force,forceSync:forceSync});case 6:r.next=12;break;case 8:r.prev=8,r.t0=r["catch"](3),(0,_error.handleError)(r.t0),process.exit(1);case 12:if(t=n.url,a=(0,_ms2["default"])(new Date-o),!clipboard){r.next=26;break}return r.prev=15,r.next=18,(0,_copy2["default"])(t);case 18:console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(t)+" (copied to clipboard) ["+a+"]"),r.next=24;break;case 21:r.prev=21,r.t1=r["catch"](15),console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(t)+" ["+a+"]");case 24:r.next=27;break;case 26:console.log("> "+t+" ["+a+"]");case 27:i=new Date,c=function(){var e=(0,_ms2["default"])(new Date-i);console.log("> Sync complete ("+(0,_bytes2["default"])(n.syncAmount)+") ["+e+"] "),n.close(),printLogs(n.host)},n.syncAmount?!function(){var e=new _progress2["default"]("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:n.syncAmount});n.upload(),n.on("upload",function(r){var o=r.name,n=r.data,t=n.length;debug&&console.log("> [debug] Uploaded: "+o+" ("+(0,_bytes2["default"])(n.length)+")"),e.tick(t)}),n.on("complete",c),n.on("error",function(e){(0,_error.error)("Upload failed"),(0,_error.handleError)(e),process.exit(1)})}():(console.log("> Sync complete (cached)"),n.close(),printLogs(n.host));case 30:case"end":return r.stop()}},r,this,[[3,8],[15,21]])}));return function(r){return e.apply(this,arguments)}}(),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_package=require("../../package"),_buildLogger=require("../lib/build-logger"),_buildLogger2=_interopRequireDefault(_buildLogger),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_error=require("../lib/error"),argv=(0,_minimist2["default"])(process.argv.slice(2)),help=function(){console.log("\n  ùö´ now [options] <command|path>\n\n  Commands:\n\n    ls | list [app]   output list of instances\n    rm | remove [id]  alias of remove\n    help [cmd]        display help for [cmd]\n\n  Options:\n\n    -h, --help          output usage information\n    -v, --version       output the version number\n    -d, --debug         Debug mode [off]\n    -f, --force         Force a new deployment even if nothing has changed\n    -L, --login         Configure login\n    -C, --no-clipboard  Do not attempt to copy URL to clipboard\n")},path=argv._[0];path?"/"!==path[0]&&(path=(0,_path.resolve)(process.cwd(),path)):path=process.cwd();var debug=argv.debug||argv.d,clipboard=!(argv.noClipboard||argv.C),force=argv.f||argv.force,forceSync=argv.F||argv.forceSync,shouldLogin=argv.L||argv.login,apiUrl=argv.url||"https://api.now.sh",config=cfg.read();argv.h||argv.help?(help(),process.exit(0)):argv.v||argv.version?(console.log(_chalk2["default"].bold("ùö´ now"),_package.version),process.exit(0)):!config.token||shouldLogin?(0,_login2["default"])(apiUrl).then(function(e){shouldLogin?(console.log("> Logged in successfully. Token saved in ~/.now.json"),process.exit(0)):sync(e)["catch"](function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)})})["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),process.exit(1)}):sync(config.token)["catch"](function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)});